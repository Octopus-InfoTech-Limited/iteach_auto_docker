server {
    listen 27080;

    location /iteach/ {
        # Preserve the full path to the Spring Boot context by omitting the path in proxy_pass
        proxy_pass http://iteach_web:26080;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Allow large file uploads and long-running parse responses
        client_max_body_size 500M;
        proxy_connect_timeout 30s;
        proxy_send_timeout 2400s;
        proxy_read_timeout 2400s;
        send_timeout 2400s;

        # Proxy settings for WebSocket
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Additional WebSocket support
        proxy_buffering off;

        # Turn off caching
        proxy_no_cache 1;
        proxy_cache_bypass 1;
    }

    location /api/ {
        # Avoid duplicating /api in upstream requests (keeps /api/... intact)
        proxy_pass http://iteach_api:26081;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Allow large file uploads and long-running parse responses
        client_max_body_size 500M;
        proxy_connect_timeout 30s;
        proxy_send_timeout 2400s;
        proxy_read_timeout 2400s;
        send_timeout 2400s;

        # Proxy settings for WebSocket
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Additional WebSocket support
        proxy_buffering off;

        # Turn off caching
        proxy_no_cache 1;
        proxy_cache_bypass 1;
    }
}

